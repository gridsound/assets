<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>build gsuiWaveletList</title>
</head>
<body>

<textarea id="output"></textarea>

<script src="../gs-utils/gs-utils.js"></script>
<script src="../gs-utils/gs-utils-dom.js"></script>
<script src="../gs-utils/gs-utils-math.js"></script>
<script src="../gs-utils/gs-utils-func.js"></script>
<script src="../gs-utils/gs-utils-files.js"></script>
<script src="../gs-utils/gs-utils-jquery.js"></script>
<script src="../gs-utils/gs-utils-checkType.dev.js"></script>
<script src="../gs-utils/gs-utils-audio-nodes.dev.js"></script>
<script>

const WFsize = 96;

function lg( ...args ) { return console.log( ...args ), args[ 0 ]; }

$( GSUdomBody ).$css( "margin", 0 );

const output = $( "#output" ).$css( {
	position: "absolute",
	inset: 0,
	border: 0,
	outline: 0,
	padding: 0,
	whiteSpace: "pre",
	resize: "none",
	color: "#fff",
	background: "#002a",
} ).$text( "drop wavelets here (*.wav)" );

function fnum( n ) {
	return GSUmathClamp( GSUmathFix( n, 2 ), -1, 1 );
}

function farr( a ) {
	return a.map( fnum ).toString().replaceAll( "0.", "." );
}

function sortArray( arr ) {
	const collator = new Intl.Collator( undefined, { numeric: true } );
	const cmp = ( a, b ) => Math.sign( collator.compare( a, b ) );

	arr.sort( ( a, b ) => cmp( a[ 0 ], b[ 0 ] ) );
	return arr;
}

document.ondragover = GSUnoopFalse;
document.ondrop = e => {
	let saveFiles;
	let ctx;

	e.preventDefault();
	e.stopPropagation();
	output.$text( "" );
	GSUgetFilesDataTransfert( e.dataTransfer.items )
		.then( files => {
			saveFiles = files;
			return Promise.all( files.map( f => GSUgetFileContent( f, "array" ) ) );
		} )
		.then( files => {
			ctx = GSUaudioContext();
			return Promise.all( files.map( f => ctx.decodeAudioData( f ) ) );
		} )
		.then( waves => {
			const waves2 = sortArray( waves.map( ( buf, i ) => [
				saveFiles[ i ].name.replaceAll( /(^a_|\.wav$)/ug, "" ),
				GSUarrayResize( buf.getChannelData( 0 ), WFsize ),
			] ) );

			ctx.close();
			const group0 = [
				[ "silence" , [ 0, 0 ] ],
				[ "sine" , GSUmathWaveSine( WFsize ) ],
				[ "triangle" , GSUmathWaveTriangle( 5 ) ],
				[ "sawtooth" , GSUmathWaveSawtooth( WFsize ) ],
				[ "square" , GSUmathWaveSquare( WFsize ) ],
			];
			const group1 = waves2.filter( w => w[ 0 ].startsWith( "GS1_" ) );
			const group2 = waves2.filter( w => w[ 0 ].startsWith( "AKWF_" ) );

			if ( group1.length + group2.length !== waves2.length ) {
				console.error( "group1.length + group2.length !== waves2.length" );
			}
			output.$text( [
				`"use strict";`,
				``,
				`/* eslint-disable */`,
				`const gsuiWaveletList = [`,
					...[
						...group0,
						...group1,
						...group2,
					].map( w => `\t["${ w[ 0 ] }",[${ farr( w[ 1 ] ) }]],` ),
				`];`,
				`/* eslint-enable */`,
				``,
			].join( "\n" ) );
		} );
};
</script>
</body>
</html>